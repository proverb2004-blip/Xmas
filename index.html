<!DOCTYPE html>
<html lang="zh">
<head>
	<script type="importmap">
	{
  	"imports": {
 	   "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
 	   "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
 	 }
	}
	</script>

	<meta charset="UTF-8">
	<title>Christmas Memory Tree</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		html,body{
  		margin:0;
 		overflow:hidden;
  		background:radial-gradient(circle at top,#123026,#000);
  		font-family: -apple-system, BlinkMacSystemFont, sans-serif;
		}

#ui{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  color:#d4af37;
  font-size:14px;
  opacity:.85;
}

#upload{
  position:fixed;
  top:20px;
  left:20px;
  z-index:10;
}

input{
  color:#fff;
  background:#143228;
  border:none;
  padding:6px 10px;
}
</style>
</head>
<body>

<div id="upload">
  <input type="file" id="photos" multiple accept="image/*">
</div>
<div id="ui">
  拖拽散开 · 旋转查看 · 点击照片 · 画圆合拢
</div>

<script type="module">
import * as THREE from "three";
import { EffectComposer } from "three/examples/jsm/postprocessing/EffectComposer.js";
import { RenderPass } from "three/examples/jsm/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "three/examples/jsm/postprocessing/UnrealBloomPass.js";

/* ==================== 基础 ==================== */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000000,15,70);

const camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,200);
camera.position.set(0,8,26);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* ==================== 后期 ==================== */
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene,camera));
composer.addPass(new UnrealBloomPass(
  new THREE.Vector2(innerWidth,innerHeight),
  1.5,0.45,0.85
));

/* ==================== 灯光 ==================== */
scene.add(new THREE.AmbientLight(0x335544,.7));
const light = new THREE.PointLight(0xffd8a8,2.4,80);
light.position.set(10,25,10);
scene.add(light);

/* ==================== 圣诞树装饰 ==================== */
const COUNT = 600;
const dummy = new THREE.Object3D();

function conePos(){
  const h=Math.random()*16;
  const r=(1-h/16)*6;
  const a=Math.random()*Math.PI*2;
  return new THREE.Vector3(
    Math.cos(a)*r,
    h-8,
    Math.sin(a)*r
  );
}

const decoGeo = new THREE.SphereGeometry(.22,16,16);
const decoMat = new THREE.MeshStandardMaterial({
  color:0xd4af37,
  metalness:.9,
  roughness:.25
});
const decorations = new THREE.InstancedMesh(decoGeo,decoMat,COUNT);

for(let i=0;i<COUNT;i++){
  dummy.position.copy(conePos());
  dummy.updateMatrix();
  decorations.setMatrixAt(i,dummy.matrix);
}
scene.add(decorations);

/* ==================== 照片 ==================== */
const photoGroup = new THREE.Group();
scene.add(photoGroup);

const loader = new THREE.TextureLoader();
let focused = null;

/* ==================== 状态 ==================== */
let mode="COLLAPSED";

/* ==================== 上传照片 ==================== */
document.getElementById("photos").addEventListener("change",e=>{
  [...e.target.files].forEach(f=>{
    const url=URL.createObjectURL(f);
    loader.load(url,tex=>{
      const mat=new THREE.MeshBasicMaterial({
        map:tex,
        transparent:true
      });
      const geo=new THREE.PlaneGeometry(2.2,2.2);
      const mesh=new THREE.Mesh(geo,mat);
      mesh.position.copy(conePos());
      mesh.userData={
        cone:mesh.position.clone(),
        scatter:new THREE.Vector3(
          THREE.MathUtils.randFloatSpread(35),
          THREE.MathUtils.randFloatSpread(20),
          THREE.MathUtils.randFloatSpread(35)
        )
      };
      photoGroup.add(mesh);
    });
  });
});

/* ==================== 鼠标交互 ==================== */
let down=false, sx=0, sy=0, dist=0;

addEventListener("mousedown",e=>{
  down=true;
  sx=e.clientX;
  sy=e.clientY;
  dist=0;
});

addEventListener("mousemove",e=>{
  if(!down)return;
  const dx=e.clientX-sx;
  const dy=e.clientY-sy;
  dist+=Math.abs(dx)+Math.abs(dy);

  if(mode==="SCATTERED"){
    camera.rotation.y-=dx*0.002;
    camera.rotation.x-=dy*0.002;
  }
  sx=e.clientX;
  sy=e.clientY;
});

addEventListener("mouseup",()=>{
  if(dist>180)setMode("SCATTERED");
  else setMode("COLLAPSED");
  down=false;
});

/* ==================== 点击照片 ==================== */
const ray=new THREE.Raycaster();
addEventListener("click",e=>{
  if(mode!=="SCATTERED")return;
  const m=new THREE.Vector2(
    e.clientX/innerWidth*2-1,
    -e.clientY/innerHeight*2+1
  );
  ray.setFromCamera(m,camera);
  const hit=ray.intersectObjects(photoGroup.children);
  if(hit.length){
    focused=hit[0].object;
    mode="FOCUS";
  }
});

/* ==================== 状态切换 ==================== */
function setMode(m){
  mode=m;
  focused=null;
}

/* ==================== 动画 ==================== */
function animate(){
  requestAnimationFrame(animate);

  photoGroup.children.forEach(p=>{
    let target;
    if(mode==="COLLAPSED")target=p.userData.cone;
    if(mode==="SCATTERED")target=p.userData.scatter;
    if(mode==="FOCUS"){
      if(p===focused)target=camera.position.clone().add(
        camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(6)
      );
      else target=p.userData.scatter;
    }
    if(target)p.position.lerp(target,.08);
  });

  composer.render();
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  composer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
